image: scratch

stages:
  - build
  - deploy

build-jar:
  image: bellsoft/liberica-openjdk-alpine:14
  stage: build
  before_script:
    - chmod +x gradlew
  script:
    - ./gradlew shadowJar
  artifacts:
    paths:
      - build/libs/*.jar
  interruptible: true
  retry: 1
  only:
    - master

heroku-deploy:
  image: ubuntu
  stage: deploy
  when: manual
  services:
    - docker:19.03.12-dind
  before_script:
    - cp $HEROKU_CREDS > ~/.netrc
    - curl https://cli-assets.heroku.com/install-ubuntu.sh | sh
    - heroku login
    - heroku container:login
  script:
    - heroku container:push web -a $HEROKU_APP_NAME
    - heroku container:release web -a $HEROKU_APP_NAME
